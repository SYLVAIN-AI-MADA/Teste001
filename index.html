<!DOCTYPE html>
<html lang="mg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>GlobalChat Pro | Sylvain Solofoniaina</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #6a11cb;
  --secondary: #2575fc;
  --bg: #0f172a;
  --glass: rgba(255,255,255,.08);
  --text: #f8fafc;
  --msg-me: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
  --msg-other: #1e293b;
}

body.light-mode {
  --bg: #f8fafc;
  --glass: rgba(0,0,0,.04);
  --text: #0f172a;
  --msg-me: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  --msg-other: #f1f5f9;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; margin: 0; overscroll-behavior: none; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; }

.app { width: 100%; max-width: 500px; height: 100dvh; display: flex; flex-direction: column; background: var(--bg); position: relative; }

header { padding: 15px; display: flex; align-items: center; justify-content: space-between; background: var(--glass); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 10; }

.screen { flex: 1; display: none; flex-direction: column; overflow: hidden; }
.active-screen { display: flex; }

#messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
.msg-wrapper { max-width: 80%; display: flex; flex-direction: column; }
.me { align-self: flex-end; }
.other { align-self: flex-start; }

.msg { padding: 12px 16px; border-radius: 20px; font-size: .95rem; line-height: 1.4; position: relative; }
.me .msg { background: var(--msg-me); color: #fff; border-bottom-right-radius: 4px; }
.other .msg { background: var(--msg-other); color: var(--text); border-bottom-left-radius: 4px; }

.time { font-size: 0.6rem; opacity: 0.5; margin-top: 2px; }
.me .time { text-align: right; }

.seen-status { font-size: .65rem; opacity: .8; color: #3b82f6; font-weight: bold; }
#typingStatus { padding: 5px 20px; font-size: .75rem; color: #3b82f6; height: 25px; font-weight: 600; font-style: italic; }

.controls { display: flex; gap: 10px; padding: 12px; background: var(--glass); backdrop-filter: blur(10px); }
.controls input { flex: 1; padding: 12px 20px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); background: var(--bg); color: var(--text); outline: none; }

button { background: none; border: none; color: var(--primary); cursor: pointer; }

.item { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid var(--glass); cursor: pointer; }
.item img { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; border: 2px solid var(--secondary); }

.nav { display: flex; background: var(--glass); border-top: 1px solid rgba(255,255,255,0.05); }
.nav button { flex: 1; padding: 12px; font-size: .75rem; color: #64748b; flex-direction: column; gap: 4px; }
.nav button.active { color: #3b82f6; }

.avatar-choice { width: 75px; height: 75px; border-radius: 50%; margin: 10px; border: 3px solid transparent; cursor: pointer; }
.avatar-choice.selected { border-color: #3b82f6; transform: scale(1.1); }

.copyright { font-size: 0.7rem; opacity: 0.4; margin-top: 20px; text-align: center; }
</style>
</head>
<body>

<div class="app">
  <div id="login" class="screen active-screen" style="justify-content: center; align-items: center; text-align: center; padding: 20px;">
    <div style="font-size: 3rem; margin-bottom: 10px;">üõ°Ô∏è</div>
    <h1 style="font-size: 2.2rem; background: var(--msg-me); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; margin:0">GlobalChat</h1>
    <p style="opacity: 0.6; margin-bottom: 20px;">Secure Private Messaging</p>
    
    <div id="avatarList">
      <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Mamy" class="avatar-choice selected" onclick="selectAv(this)">
      <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Sary" class="avatar-choice" onclick="selectAv(this)">
      <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Koto" class="avatar-choice" onclick="selectAv(this)">
    </div>
    
    <input id="loginName" placeholder="Anaranao..." style="width: 85%; padding: 16px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); background: var(--glass); color: white; outline: none; text-align: center; margin-top: 20px;">
    <button onclick="doLogin()" style="background: var(--msg-me); color: white; padding: 16px; border-radius: 15px; font-weight: bold; width: 85%; margin-top: 20px; border: none;">HIDITRA ‚ûî</button>
    <div class="copyright">Developed by Sylvain Solofoniaina<br>¬© 2026 Pro Version</div>
  </div>

  <div id="main" style="display:none; flex:1; flex-direction:column">
    <div id="rooms" class="screen active-screen">
      <header><b>Hafatra üí¨</b><button onclick="toggleTheme()">üåì</button></header>
      <div id="userList" style="flex:1; overflow-y:auto"></div>
    </div>

    <div id="chat" class="screen">
      <header>
        <button onclick="closeChat()">‚úï</button>
        <b id="activeChatName"></b>
        <button onclick="alert('Antso feo ho avy...')">üìû</button>
      </header>
      <div id="messages"></div>
      <div id="typingStatus"></div>
      <div class="controls">
        <button onclick="fileIn.click()">‚äï</button>
        <input id="msgInput" placeholder="Manorata hafatra..." oninput="sendTyping()" onkeydown="if(event.key==='Enter') sendMsg()">
        <button onclick="sendMsg()" style="background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%;">‚û§</button>
        <input type="file" id="fileIn" hidden accept="image/*" onchange="uploadPhoto(this)">
      </div>
    </div>

    <div id="settings" class="screen">
      <header><b>Profile üë§</b></header>
      <div style="text-align:center; padding:40px 20px;">
        <img id="myProfPic" style="width:120px; height:120px; border-radius:50%; border:4px solid #3b82f6;">
        <h2 id="myProfName" style="margin-top:15px"></h2>
        <div style="background: var(--glass); border-radius: 15px; padding: 15px; margin: 20px 0; text-align: left;">
            <p style="margin:0; font-size:0.8rem"><b>Auteur:</b> Sylvain Solofoniaina</p>
            <p style="margin:5px 0 0; font-size:0.8rem"><b>Statut:</b> Voaaro (Encrypted)</p>
        </div>
        <button onclick="logout()" style="background:#ef4444; color:white; padding:15px; border-radius:15px; width:100%; border:none; font-weight:bold;">HIALA (LOGOUT)</button>
      </div>
    </div>

    <div class="nav">
      <button id="nav-rooms" class="active" onclick="show('rooms')"><b>üí¨</b>Chats</button>
      <button id="nav-settings" onclick="show('settings')"><b>üë§</b>Profile</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<script>
// AMPIFIDIRO ETO NY CONFIG FIREBASE-NAO
const firebaseConfig = {
  apiKey: "AIzaSyAJAy-RPWZiqrngfpOVBxsq9FSvms5hFGI",
  authDomain: "lgbtq-pro.firebaseapp.com",
  projectId: "lgbtq-pro",
  storageBucket: "lgbtq-pro.firebasestorage.app",
  messagingSenderId: "188046971429",
  appId: "1:188046971429:web:b99215b46097c8ac8a65cc"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const st = firebase.storage();

let user = {name:"", avatar:""};
let activeChatId = "";
let unsubMsg = null;
let unsubTyping = null;

function $(i){return document.getElementById(i);}

function selectAv(el){
  document.querySelectorAll('.avatar-choice').forEach(a=>a.classList.remove('selected'));
  el.classList.add('selected');
  user.avatar = el.src;
}

async function doLogin(){
  const n = $("loginName").value.trim();
  if(!n) return alert("Ampidiro ny anaranao!");
  user.name = n;
  user.avatar = document.querySelector('.avatar-choice.selected').src;

  // Rehefa miditra voalohany dia save-na
  await db.collection("users").doc(user.name).set({
    name:user.name, avatar:user.avatar, online:true, lastSeen: Date.now()
  },{merge:true});

  localStorage.lgbtUser = JSON.stringify(user);
  $("login").style.display="none";
  $("main").style.display="flex";
  loadUsers();
}

function loadUsers(){
  db.collection("users").onSnapshot(s=>{
    $("userList").innerHTML="";
    if(s.empty) {
        $("userList").innerHTML = "<p style='text-align:center; opacity:0.5; margin-top:50px'>Mbola tsy misy olona hafa...</p>";
    }
    s.forEach(d=>{
      if(d.id !== user.name){
        const u = d.data();
        $("userList").innerHTML += `
          <div class="item" onclick="openChat('${u.name}')">
            <img src="${u.avatar}">
            <div><b>${u.name}</b><br><small style="opacity:0.6">${u.online?'Online izao':'Offline'}</small></div>
          </div>`;
      }
    });
  });
}

function openChat(otherName){
  activeChatId = [user.name, otherName].sort().join("_");
  $("activeChatName").innerText = otherName;
  show('chat');

  if(unsubMsg) unsubMsg();
  unsubMsg = db.collection("private_chats").doc(activeChatId).collection("messages").orderBy("ts")
    .onSnapshot(s => {
      $("messages").innerHTML = "";
      s.forEach(d => {
        const m = d.data();
        const isMe = m.sender === user.name;
        const ora = new Date(m.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        if(!isMe && m.status === 'sent') d.ref.update({status:'seen'});

        $("messages").innerHTML += `
          <div class="msg-wrapper ${isMe?'me':'other'}" onclick="deleteMsg('${d.id}', ${isMe})">
            <div class="msg">${m.text || `<img src="${m.img}" style="max-width:200px; border-radius:12px">`}</div>
            <div class="time">${ora} ${isMe ? `<span class="seen-status">${m.status==='seen'?'‚úî‚úî':'‚úî'}</span>` : ''}</div>
          </div>`;
      });
      $("messages").scrollTop = $("messages").scrollHeight;
    });

  if(unsubTyping) unsubTyping();
  unsubTyping = db.collection("private_chats").doc(activeChatId).onSnapshot(d => {
    if(d.exists()){
      const data = d.data();
      $("typingStatus").innerText = data[`typing_${otherName}`] ? otherName + " manoratra..." : "";
    }
  });
}

function sendTyping(){
  const isTyping = $("msgInput").value.trim().length > 0;
  db.collection("private_chats").doc(activeChatId).set({
    [`typing_${user.name}`]: isTyping
  }, {merge:true});
}

function sendMsg(){
  const val = $("msgInput").value.trim();
  if(!val) return;
  db.collection("private_chats").doc(activeChatId).collection("messages").add({
    sender: user.name, text: val, ts: Date.now(), status: 'sent'
  });
  $("msgInput").value = "";
  db.collection("private_chats").doc(activeChatId).set({ [`typing_${user.name}`]: false }, {merge:true});
}

async function uploadPhoto(i){
  const f = i.files[0];
  if(!f) return;
  const r = st.ref("private/"+Date.now()+f.name);
  await r.put(f);
  const url = await r.getDownloadURL();
  db.collection("private_chats").doc(activeChatId).collection("messages").add({
    sender: user.name, img: url, ts: Date.now(), status: 'sent'
  });
}

function deleteMsg(id, isMe) {
    if(isMe && confirm("Hamafa ity hafatra ity?")) {
        db.collection("private_chats").doc(activeChatId).collection("messages").doc(id).delete();
    }
}

function closeChat(){
  if(activeChatId) db.collection("private_chats").doc(activeChatId).set({ [`typing_${user.name}`]: false }, {merge:true});
  show('rooms');
}

function toggleTheme(){ document.body.classList.toggle('light-mode'); }

function show(id){
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
  $(id).classList.add('active-screen');
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
  if($('nav-'+id)) $('nav-'+id).classList.add('active');
  if(id === 'settings'){
    $("myProfPic").src = user.avatar;
    $("myProfName").innerText = user.name;
  }
}

function logout(){
  if(user.name) db.collection("users").doc(user.name).update({online:false});
  localStorage.clear();
  location.reload();
}

window.onload=()=>{
  if(localStorage.lgbtUser){
    user = JSON.parse(localStorage.lgbtUser);
    $("login").style.display="none";
    $("main").style.display="flex";
    loadUsers();
    db.collection("users").doc(user.name).update({online:true});
  }
}
</script>
</body>
</html>
