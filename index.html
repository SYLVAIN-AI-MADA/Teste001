<!DOCTYPE html>
<html lang="mg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>LGBT+ Messenger Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --rainbow: linear-gradient(90deg, #ff2400, #e81d1d, #e8b71d, #1de840, #1ddde8, #2b1de8, #dd00f3);
            --bg: #0f0c29;
            --glass: rgba(255, 255, 255, 0.1);
            --accent: #f39c12;
            --text: #ffffff;
            --msg-me: #8e44ad;
            --msg-other: rgba(255, 255, 255, 0.15);
        }

        body.light-mode {
            --bg: #f0f2f5;
            --glass: rgba(0, 0, 0, 0.05);
            --text: #1c1e21;
            --msg-me: #0084ff;
            --msg-other: #e4e6eb;
        }

        * { box-sizing: border-box; transition: background 0.3s, color 0.3s; }
        body { 
            margin: 0; font-family: 'Poppins', sans-serif; height: 100vh;
            background: var(--bg); color: var(--text);
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }

        .app { 
            width: 100%; max-width: 500px; height: 100vh; 
            background: var(--glass); backdrop-filter: blur(20px);
            display: flex; flex-direction: column; position: relative;
        }

        header { 
            padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--glass);
        }

        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg-wrapper { display: flex; flex-direction: column; max-width: 85%; position: relative; cursor: pointer; }
        .msg-wrapper.me { align-self: flex-end; align-items: flex-end; }
        .msg-wrapper.other { align-self: flex-start; align-items: flex-start; }

        .msg { padding: 10px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; }
        .me .msg { background: var(--msg-me); color: white; border-bottom-right-radius: 4px; }
        .other .msg { background: var(--msg-other); color: var(--text); border-bottom-left-radius: 4px; }

        .seen-status { font-size: 0.65rem; opacity: 0.6; margin-top: 2px; }
        #typingStatus { font-size: 0.75rem; padding: 5px 20px; color: var(--accent); height: 25px; font-style: italic; font-weight: 600; }

        .controls { padding: 15px; display: flex; gap: 10px; align-items: center; background: rgba(0,0,0,0.1); }
        .controls input { 
            flex: 1; padding: 12px 18px; border-radius: 25px; border: none; 
            background: var(--glass); color: var(--text); outline: none;
        }

        .screen { flex: 1; display: none; flex-direction: column; overflow-y: auto; }
        .active-screen { display: flex; }

        .item { padding: 15px 20px; display: flex; align-items: center; gap: 15px; cursor: pointer; border-bottom: 1px solid var(--glass); }
        .item img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .online-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--bg); margin-left: -25px; margin-top: 35px; z-index: 2; }

        .nav { display: flex; padding: 10px 0; background: rgba(0,0,0,0.3); border-top: 1px solid var(--glass); }
        .nav button { flex: 1; background: none; border: none; color: #888; cursor: pointer; font-size: 0.7rem; }
        .nav button.active { color: var(--accent); }
        .nav .icon { font-size: 1.5rem; display: block; }

        #callOverlay { position: absolute; inset: 0; background: radial-gradient(circle, #302b63, #0f0c29); z-index: 500; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .call-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; cursor: pointer; font-size: 1.5rem; }
    </style>
</head>
<body>

<div class="app">
    <div id="login" class="screen active-screen">
        <h1 style="background:var(--rainbow); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-size:3rem; text-align:center;">LGBT+</h1>
        <div id="avatarList" style="text-align:center; margin: 20px 0;">
            <img class="avatar-choice selected" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" onclick="selectAv(this)" style="width:70px; cursor:pointer; border-radius:50%; margin:5px;">
            <img class="avatar-choice" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Luna" onclick="selectAv(this)" style="width:70px; cursor:pointer; border-radius:50%; margin:5px;">
        </div>
        <input type="text" id="loginName" placeholder="Anaranao..." style="width:85%; display:block; margin: 10px auto; padding:15px; border-radius:25px; border:none; background:var(--glass); color:var(--text);">
        <button class="btn" onclick="doLogin()" style="width:85%; display:block; margin: 20px auto; padding:15px; border-radius:25px; background:var(--accent); color:white; border:none; font-weight:bold;">MIDITRA</button>
    </div>

    <div id="main" style="display:none; flex:1; flex-direction:column;">
        <div id="rooms" class="screen">
            <header><span style="font-size:1.5rem; font-weight:bold;">Messenger</span><button onclick="toggleTheme()" style="background:none; border:none; font-size:1.2rem;">üåì</button></header>
            <div id="userList"></div>
        </div>

        <div id="chat" class="screen">
            <header>
                <button onclick="show('rooms')" style="background:none; border:none; color:var(--text); font-size:1.5rem;">‚Üê</button>
                <div style="flex:1; margin-left:15px;"><b id="activeChatName">Anarana</b><br><small id="activeStatus" style="opacity:0.6;">Online</small></div>
                <button onclick="makeCall()" style="background:none; border:none; font-size:1.3rem;">üìû</button>
            </header>
            <div id="messages"></div>
            <div id="typingStatus"></div>
            <div class="controls">
                <button onclick="$('fileIn').click()" style="background:none; border:none; font-size:1.5rem;">üñºÔ∏è</button>
                <input type="text" id="msgInput" placeholder="Hafatra..." oninput="sendTyping()">
                <button onclick="sendMsg()" style="background:none; border:none; color:var(--accent); font-size:1.5rem;">‚û§</button>
                <input type="file" id="fileIn" style="display:none" accept="image/*" onchange="uploadPhoto(this)">
            </div>
        </div>

        <div id="settings" class="screen">
            <header>Profile</header>
            <div style="text-align:center; padding:40px;">
                <img id="myProfPic" style="width:120px; height:120px; border-radius:50%; border:4px solid var(--accent);">
                <h2 id="myProfName"></h2>
                <button class="btn" style="background:#e74c3c; padding:15px 30px; border-radius:25px; border:none; color:white; margin-top:20px;" onclick="logout()">LOGOUT</button>
            </div>
        </div>

        <div class="nav">
            <button id="nav-rooms" onclick="show('rooms')" class="active"><span class="icon">üí¨</span>Chats</button>
            <button id="nav-settings" onclick="show('settings')"><span class="icon">‚öôÔ∏è</span>Me</button>
        </div>
    </div>

    <div id="callOverlay">
        <div style="text-align:center; color:white;">
            <div id="callAv" style="width:120px; height:120px; border-radius:50%; background:var(--accent); margin: 0 auto 20px auto; display:flex; align-items:center; justify-content:center; font-size:3rem;">üë§</div>
            <h2 id="callNameDisplay">Anarana</h2>
            <p>Miantso anao...</p>
            <div style="display:flex; gap:30px; margin-top:50px;">
                <button class="call-btn" style="background:#2ecc71;">üìû</button>
                <button class="call-btn" style="background:#e74c3c;" onclick="endCall()">‚úñ</button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAJAy-RPWZiqrngfpOVBxsq9FSvms5hFGI",
        authDomain: "lgbtq-pro.firebaseapp.com",
        projectId: "lgbtq-pro",
        storageBucket: "lgbtq-pro.firebasestorage.app",
        messagingSenderId: "188046971429",
        appId: "1:188046971429:web:b99215b46097c8ac8a65cc"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const st = firebase.storage();

    let user = { name: "", avatar: "" };
    let activeChatId = "";
    let unsubMessages = null;
    let unsubChatDoc = null;

    function $(id) { return document.getElementById(id); }

    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        localStorage.theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
    }

    function selectAv(el) {
        document.querySelectorAll('.avatar-choice').forEach(i => i.classList.remove('selected'));
        el.style.border = "3px solid var(--accent)";
        user.avatar = el.src;
    }

    async function doLogin() {
        const n = $('loginName').value.trim();
        if(!n) return alert("Anarana azafady");
        user.name = n;
        if(!user.avatar) user.avatar = $('avatarList').children[0].src;
        await db.collection("users").doc(user.name).set({ name: user.name, avatar: user.avatar, online: true }, {merge: true});
        localStorage.lgbtUser = JSON.stringify(user);
        $('login').style.display = 'none';
        $('main').style.display = 'flex';
        loadUsers();
    }

    function loadUsers() {
        db.collection("users").onSnapshot(snap => {
            $('userList').innerHTML = "";
            snap.forEach(doc => {
                if(doc.id !== user.name) {
                    const u = doc.data();
                    $('userList').innerHTML += `
                        <div class="item" onclick="openChat('${u.name}', '${u.avatar}')">
                            <img src="${u.avatar}">
                            <div class="online-dot" style="background:${u.online ? '#2ecc71' : '#95a5a6'}"></div>
                            <div style="flex:1"><b>${u.name}</b><br><small>${u.online ? 'Mavitrika' : 'Tsy eo'}</small></div>
                        </div>`;
                }
            });
        });
    }

    function openChat(name, avatar) {
        activeChatId = [user.name, name].sort().join("_");
        $('activeChatName').innerText = name;
        show('chat');
        loadMessages();
        watchChatData(name);
    }

    function loadMessages() {
        if(unsubMessages) unsubMessages();
        unsubMessages = db.collection("chats").doc(activeChatId).collection("messages")
            .orderBy("ts", "asc").onSnapshot(snap => {
                let html = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    const isMe = m.sender === user.name;
                    if(!isMe && m.status === 'sent') doc.ref.update({ status: 'seen' });
                    html += `
                        <div class="msg-wrapper ${isMe ? 'me' : 'other'}" onclick="${isMe ? `deleteMsg('${doc.id}')` : ''}">
                            <div class="msg">${m.text ? m.text : `<img src="${m.img}" style="width:100%; max-width:200px; border-radius:10px;">`}</div>
                            <div class="seen-status">${isMe ? (m.status === 'seen' ? '‚úî Vue' : '‚úî Nalefa') : ''}</div>
                        </div>`;
                });
                $('messages').innerHTML = html;
                $('messages').scrollTop = $('messages').scrollHeight;
            });
    }

    function sendTyping() {
        const isTyping = $('msgInput').value.length > 0;
        db.collection("chats").doc(activeChatId).set({ [`typing_${user.name}`]: isTyping }, { merge: true });
    }

    function watchChatData(otherName) {
        if(unsubChatDoc) unsubChatDoc();
        unsubChatDoc = db.collection("chats").doc(activeChatId).onSnapshot(doc => {
            if(doc.exists) {
                const data = doc.data();
                $('typingStatus').innerText = data[`typing_${otherName}`] ? otherName + " manoratra..." : "";
            }
        });
    }

    async function sendMsg() {
        const text = $('msgInput').value.trim();
        if(!text) return;
        const msgData = { sender: user.name, text: text, ts: Date.now(), status: 'sent' };
        $('msgInput').value = "";
        db.collection("chats").doc(activeChatId).set({ [`typing_${user.name}`]: false }, { merge: true });
        await db.collection("chats").doc(activeChatId).collection("messages").add(msgData);
    }

    async function uploadPhoto(el) {
        const file = el.files[0];
        if(!file) return;
        const ref = st.ref('chats/'+Date.now()+file.name);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        await db.collection("chats").doc(activeChatId).collection("messages").add({
            sender: user.name, img: url, ts: Date.now(), status: 'sent'
        });
    }

    async function deleteMsg(id) {
        if(confirm("Hamafa ity hafatra ity ho an'ny rehetra?")) {
            await db.collection("chats").doc(activeChatId).collection("messages").doc(id).delete();
        }
    }

    function show(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        $(id).classList.add('active-screen');
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        if($('nav-'+id)) $('nav-'+id).classList.add('active');
        if(id === 'settings') { $('myProfPic').src = user.avatar; $('myProfName').innerText = user.name; }
    }

    function makeCall() { $('callOverlay').style.display = 'flex'; $('callNameDisplay').innerText = $('activeChatName').innerText; }
    function endCall() { $('callOverlay').style.display = 'none'; }
    function logout() { 
        db.collection("users").doc(user.name).update({ online: false });
        localStorage.clear(); location.reload(); 
    }

    window.onload = () => {
        if(localStorage.theme === 'light') document.body.classList.add('light-mode');
        if(localStorage.lgbtUser) {
            user = JSON.parse(localStorage.lgbtUser);
            $('login').style.display = 'none'; $('main').style.display = 'flex';
            loadUsers();
            db.collection("users").doc(user.name).update({ online: true });
        }
    }
</script>
</body>
</html>
