<!DOCTYPE html>
<html lang="mg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>GlobalChat Pro | Sylvain Solofoniaina</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #6a11cb;
  --secondary: #2575fc;
  --bg: #0f172a;
  --glass: rgba(255,255,255,.08);
  --text: #f8fafc;
  --msg-me: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
  --msg-other: #1e293b;
}

body.light-mode {
  --bg: #f8fafc;
  --glass: rgba(0,0,0,.04);
  --text: #0f172a;
  --msg-me: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  --msg-other: #f1f5f9;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; margin: 0; overscroll-behavior: none; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); }

.app { width: 100%; max-width: 500px; height: 100dvh; display: flex; flex-direction: column; margin: auto; background: var(--bg); position: relative; }

header { padding: 15px; display: flex; align-items: center; gap: 10px; background: var(--glass); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 10; }

.screen { flex: 1; display: none; flex-direction: column; overflow: hidden; }
.active-screen { display: flex; }

#messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
.msg-wrapper { max-width: 85%; display: flex; flex-direction: column; margin-bottom: 5px; }
.me { align-self: flex-end; }
.other { align-self: flex-start; }

.msg { padding: 10px 14px; border-radius: 18px; font-size: .95rem; line-height: 1.4; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.me .msg { background: var(--msg-me); color: #fff; border-bottom-right-radius: 4px; }
.other .msg { background: var(--msg-other); color: var(--text); border-bottom-left-radius: 4px; }

.time-box { font-size: 0.65rem; opacity: 0.6; margin-top: 3px; display: flex; align-items: center; gap: 4px; }
.me .time-box { justify-content: flex-end; }

#typingStatus { padding: 5px 20px; font-size: .75rem; color: #3b82f6; height: 25px; font-weight: 600; }

.controls { display: flex; gap: 8px; padding: 12px; background: var(--glass); }
.controls input { flex: 1; padding: 12px 18px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); background: var(--bg); color: var(--text); outline: none; }

.nav { display: flex; background: var(--glass); border-top: 1px solid rgba(255,255,255,0.05); }
.nav button { flex: 1; padding: 15px; font-size: .75rem; color: #64748b; border: none; background: none; display: flex; flex-direction: column; align-items: center; }
.nav button.active { color: #3b82f6; }

/* CALL OVERLAY */
#callOverlay { position: absolute; inset: 0; background: radial-gradient(circle, #2575fc, #0f172a); display: none; z-index: 100; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
.call-avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid white; margin-bottom: 20px; animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(255,255,255,0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0); } }

.btn-call { padding: 15px 30px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; margin: 10px; }
</style>
</head>
<body>

<div class="app">
    <div id="login" class="screen active-screen" style="justify-content:center; align-items:center; padding:30px;">
        <h1 style="background:var(--msg-me); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-size:2.5rem; margin:0">GlobalChat</h1>
        <p style="opacity:0.6">By Sylvain Solofoniaina</p>
        <input id="loginName" placeholder="Anaranao..." style="width:100%; padding:15px; border-radius:15px; border:1px solid rgba(255,255,255,0.1); background:var(--glass); color:white; margin-top:20px; text-align:center;">
        <button onclick="doLogin()" style="width:100%; background:var(--primary); color:white; padding:15px; border-radius:15px; border:none; margin-top:15px; font-weight:bold;">HIDITRA âž”</button>
    </div>

    <div id="main" style="display:none; flex:1; flex-direction:column">
        <div id="rooms" class="screen active-screen">
            <header><b>Hafatra ðŸ’¬</b><button onclick="document.body.classList.toggle('light-mode')" style="background:none; border:none; font-size:1.2rem; color:var(--text)">ðŸŒ“</button></header>
            <div id="userList" style="flex:1; overflow-y:auto"></div>
        </div>

        <div id="chat" class="screen">
            <header>
                <button onclick="closeChat()" style="background:none; border:none; color:var(--text); font-size:1.5rem">âœ•</button>
                <b id="activeChatName" style="flex:1"></b>
                <button onclick="startCall()" style="background:none; border:none; color:var(--secondary); font-size:1.4rem">ðŸ“ž</button>
            </header>
            <div id="messages"></div>
            <div id="typingStatus"></div>
            <div class="controls">
                <input id="msgInput" placeholder="Hafatra..." oninput="sendTyping()" onkeydown="if(event.key==='Enter') sendMsg()">
                <button onclick="sendMsg()" style="background:var(--primary); color:white; width:45px; height:45px; border-radius:50%; border:none;">âž¤</button>
            </div>
        </div>

        <div class="nav">
            <button id="nav-rooms" class="active" onclick="show('rooms')"><span>ðŸ’¬</span>Chats</button>
            <button onclick="logout()"><span>ðŸ‘¤</span>Hiala</button>
        </div>
    </div>

    <div id="callOverlay">
        <img id="callUserImg" class="call-avatar" src="">
        <h2 id="callUserName" style="color:white; margin:0"></h2>
        <p style="color:white; opacity:0.8" id="callStatus">Miantso...</p>
        <div style="margin-top:50px">
            <button class="btn-call" style="background:#ef4444; color:white;" onclick="endCall()">HAFESANA</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// CONFIG FIREBASE (Ampiasao ny anao foana)
const firebaseConfig = {
  apiKey: "AIzaSyAJAy-RPWZiqrngfpOVBxsq9FSvms5hFGI",
  authDomain: "lgbtq-pro.firebaseapp.com",
  projectId: "lgbtq-pro",
  storageBucket: "lgbtq-pro.firebasestorage.app",
  messagingSenderId: "188046971429",
  appId: "1:188046971429:web:b99215b46097c8ac8a65cc"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let user = {name:""};
let activeChatId = "";
let unsubMsg = null;
let unsubTyping = null;

function $(i){return document.getElementById(i);}

async function doLogin(){
    const n = $("loginName").value.trim();
    if(!n) return;
    user.name = n;
    localStorage.chatUser = n;
    await db.collection("users").doc(n).set({name:n, online:true, last: Date.now()},{merge:true});
    $("login").style.display="none";
    $("main").style.display="flex";
    loadUsers();
    listenForCalls();
}

function loadUsers(){
    db.collection("users").onSnapshot(s => {
        $("userList").innerHTML = "";
        s.forEach(d => {
            if(d.id !== user.name){
                $("userList").innerHTML += `<div style="padding:15px; border-bottom:1px solid var(--glass); cursor:pointer" onclick="openChat('${d.id}')"><b>${d.id}</b><br><small style="opacity:0.6">${d.data().online?'Online':'Offline'}</small></div>`;
            }
        });
    });
}

function openChat(other){
    activeChatId = [user.name, other].sort().join("_");
    $("activeChatName").innerText = other;
    show('chat');

    if(unsubMsg) unsubMsg();
    // ORDERED BY TS ASCENDING (Mba hifanaraka tsara)
    unsubMsg = db.collection("private_chats").doc(activeChatId).collection("messages")
        .orderBy("ts", "asc")
        .onSnapshot(s => {
            $("messages").innerHTML = "";
            s.forEach(d => {
                const m = d.data();
                const isMe = m.sender === user.name;
                // Raha tsy mbola misy "ts" (Server delay), ampiasao ny ora izao
                const dDate = m.ts ? m.ts.toDate() : new Date();
                const ora = dDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

                $("messages").innerHTML += `
                    <div class="msg-wrapper ${isMe?'me':'other'}">
                        <div class="msg">${m.text}</div>
                        <div class="time-box">${ora} ${isMe ? (m.seen?'âœ”âœ”':'âœ”') : ''}</div>
                    </div>`;
                if(!isMe && !m.seen) d.ref.update({seen:true});
            });
            $("messages").scrollTop = $("messages").scrollHeight;
        });

    if(unsubTyping) unsubTyping();
    unsubTyping = db.collection("private_chats").doc(activeChatId).onSnapshot(d => {
        if(d.exists()) $("typingStatus").innerText = d.data()["typ_"+other] ? other+" manoratra..." : "";
    });
}

function sendMsg(){
    const txt = $("msgInput").value.trim();
    if(!txt) return;
    db.collection("private_chats").doc(activeChatId).collection("messages").add({
        sender: user.name,
        text: txt,
        ts: firebase.firestore.FieldValue.serverTimestamp(), // ORA AVY AMIN'NY SERVER
        seen: false
    });
    $("msgInput").value = "";
    db.collection("private_chats").doc(activeChatId).set({["typ_"+user.name]:false},{merge:true});
}

function sendTyping(){
    db.collection("private_chats").doc(activeChatId).set({
        ["typ_"+user.name]: $("msgInput").value.length > 0
    },{merge:true});
}

/* --- SYSTEME APPEL --- */
function startCall(){
    const other = $("activeChatName").innerText;
    $("callUserName").innerText = other;
    $("callUserImg").src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${other}`;
    $("callOverlay").style.display = "flex";
    
    db.collection("calls").doc(other).set({
        caller: user.name,
        status: "ringing",
        ts: Date.now()
    });
}

function listenForCalls(){
    db.collection("calls").doc(user.name).onSnapshot(d => {
        if(d.exists() && d.data().status === "ringing"){
            const caller = d.data().caller;
            if(confirm("Miantso i " + caller + ". Handray ve ianao?")){
                alert("Mifandray ny feo...");
                db.collection("calls").doc(user.name).delete();
            } else {
                endCall();
            }
        }
    });
}

function endCall(){
    $("callOverlay").style.display = "none";
    db.collection("calls").doc(user.name).delete();
}

function show(id){
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
    $(id).classList.add('active-screen');
}
function closeChat(){ show('rooms'); }
function logout(){ localStorage.clear(); location.reload(); }

window.onload = () => {
    if(localStorage.chatUser) {
        $("loginName").value = localStorage.chatUser;
        doLogin();
    }
}
</script>
</body>
</html>
