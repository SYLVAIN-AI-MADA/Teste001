<!DOCTYPE html>
<html lang="mg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>GlobalChat Pro | Sylvain Solofoniaina</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
    --messenger-blue: #0084ff;
    --bg-dark: #000000;
    --bg-light: #ffffff;
    --bubble-me: #0084ff;
    --bubble-other: #3e4042;
    --text-main: #e4e6eb;
    --glass: rgba(255, 255, 255, 0.1);
}

body.light-mode {
    --bg-dark: #ffffff;
    --text-main: #050505;
    --bubble-other: #e4e6eb;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body, html { height: 100%; margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); overflow: hidden; }

.app { width: 100%; max-width: 500px; height: 100dvh; display: flex; flex-direction: column; margin: auto; position: relative; border-left: 1px solid var(--glass); border-right: 1px solid var(--glass); }

/* SCREENS */
.screen { flex: 1; display: none; flex-direction: column; height: 100%; overflow: hidden; }
.active { display: flex; }

/* HEADER */
header { padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--glass); background: var(--bg-dark); z-index: 10; }
header b { font-size: 1.2rem; }

/* USER LIST */
#userList { flex: 1; overflow-y: auto; padding: 10px; }
.user-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
.user-item:active { background: var(--glass); }
.user-avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; background: #333; }
.status-dot { width: 12px; height: 12px; border-radius: 50%; background: #31a24c; border: 2px solid var(--bg-dark); margin-left: -25px; margin-top: 35px; }

/* CHAT BOX */
#messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 4px; }
.msg-row { display: flex; flex-direction: column; max-width: 75%; position: relative; margin-bottom: 2px; }
.msg-row.me { align-self: flex-end; align-items: flex-end; }
.msg-row.other { align-self: flex-start; align-items: flex-start; }

.bubble { padding: 8px 14px; border-radius: 18px; font-size: 0.95rem; line-height: 1.3; word-wrap: break-word; }
.me .bubble { background: var(--bubble-me); color: white; border-bottom-right-radius: 4px; }
.other .bubble { background: var(--bubble-other); color: var(--text-main); border-bottom-left-radius: 4px; }

.msg-info { font-size: 0.65rem; opacity: 0.6; margin-top: 2px; }

/* INPUT AREA */
.input-area { padding: 10px; display: flex; align-items: center; gap: 10px; border-top: 1px solid var(--glass); }
.input-area input { flex: 1; padding: 10px 16px; border-radius: 20px; border: none; background: var(--bubble-other); color: var(--text-main); outline: none; }
.btn-send { background: none; border: none; color: var(--messenger-blue); font-size: 1.5rem; cursor: pointer; }

/* CALL OVERLAY */
#callScreen { position: absolute; inset: 0; background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
.call-img { width: 120px; height: 120px; border-radius: 50%; border: 3px solid white; margin-bottom: 20px; animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: 0 0 0 20px rgba(255,255,255,0); } 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); } }

/* NAVIGATION */
.bottom-nav { display: flex; border-top: 1px solid var(--glass); padding: 5px 0; background: var(--bg-dark); }
.nav-item { flex: 1; text-align: center; padding: 10px; font-size: 0.75rem; cursor: pointer; opacity: 0.6; }
.nav-item.active { opacity: 1; color: var(--messenger-blue); }
</style>
</head>
<body>

<div class="app">
    <div id="login" class="screen active" style="justify-content:center; align-items:center; padding:40px;">
        <h1 style="color:var(--messenger-blue); font-size: 2.5rem; margin-bottom: 5px;">GlobalChat</h1>
        <p style="opacity:0.5; margin-bottom:30px;">By Sylvain Solofoniaina</p>
        <input id="userName" placeholder="Anaranao..." style="width:100%; padding:15px; border-radius:15px; border:1px solid var(--glass); background:var(--bubble-other); color:white; text-align:center; font-size:1rem;">
        <button onclick="login()" style="width:100%; padding:15px; border-radius:15px; border:none; background:var(--messenger-blue); color:white; font-weight:bold; margin-top:15px; cursor:pointer;">HIDITRA</button>
        <p style="font-size: 0.7rem; opacity: 0.3; margin-top: 40px;">Â© 2026 Copyright Reserved</p>
    </div>

    <div id="main" class="screen">
        <div id="rooms" class="screen active">
            <header>
                <b>Chats</b>
                <button onclick="document.body.classList.toggle('light-mode')" style="background:none; border:none; font-size:1.3rem;">ðŸŒ“</button>
            </header>
            <div id="userList"></div>
            <div class="bottom-nav">
                <div class="nav-item active">ðŸ’¬<br>Chats</div>
                <div class="nav-item" onclick="logout()">ðŸ‘¤<br>Hiala</div>
            </div>
        </div>

        <div id="chat" class="screen">
            <header>
                <button onclick="closeChat()" style="background:none; border:none; color:var(--messenger-blue); font-size:1.5rem;">âœ•</button>
                <b id="chatTitle" style="flex:1; margin-left:10px;">Anarana</b>
                <button onclick="makeCall()" style="background:none; border:none; color:var(--messenger-blue); font-size:1.3rem;">ðŸ“ž</button>
            </header>
            <div id="messages"></div>
            <div id="typingInfo" style="padding: 2px 15px; font-size: 0.7rem; color: var(--messenger-blue); height: 15px;"></div>
            <div class="input-area">
                <input id="msgInput" placeholder="Hafatra..." oninput="isTyping()" onkeydown="if(event.key==='Enter') send()">
                <button class="btn-send" onclick="send()">âž¤</button>
            </div>
        </div>
    </div>

    <div id="callScreen">
        <img id="callImg" class="call-img" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Call">
        <h2 id="callName" style="color:white;">Miantso...</h2>
        <p id="callStatus" style="color:white; opacity:0.7;">Miantso...</p>
        <button onclick="endCall()" style="background:#ff3b30; color:white; padding:15px 40px; border-radius:30px; border:none; margin-top:40px; font-weight:bold;">HAFESANA</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// CONFIG FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyAJAy-RPWZiqrngfpOVBxsq9FSvms5hFGI",
    authDomain: "lgbtq-pro.firebaseapp.com",
    projectId: "lgbtq-pro",
    storageBucket: "lgbtq-pro.firebasestorage.app",
    messagingSenderId: "188046971429",
    appId: "1:188046971429:web:b99215b46097c8ac8a65cc"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let myName = "";
let activeChat = "";
let unsub = null;

function login() {
    const n = document.getElementById("userName").value.trim();
    if(!n) return;
    myName = n;
    localStorage.chatUser = n;
    db.collection("users").doc(n).set({ name: n, online: true, last: Date.now() }, {merge: true});
    document.getElementById("login").classList.remove("active");
    document.getElementById("main").classList.add("active");
    loadUsers();
    listenCalls();
}

function loadUsers() {
    db.collection("users").onSnapshot(snap => {
        const list = document.getElementById("userList");
        list.innerHTML = "";
        snap.forEach(doc => {
            if(doc.id !== myName) {
                const u = doc.data();
                list.innerHTML += `
                    <div class="user-item" onclick="openChat('${u.name}')">
                        <img class="user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=${u.name}">
                        <div class="status-dot" style="background:${u.online?'#31a24c':'#888'}"></div>
                        <div style="flex:1"><b>${u.name}</b><br><small style="opacity:0.5">${u.online?'Online':'Offline'}</small></div>
                    </div>`;
            }
        });
    });
}

function openChat(other) {
    activeChat = [myName, other].sort().join("_");
    document.getElementById("chatTitle").innerText = other;
    document.getElementById("rooms").classList.remove("active");
    document.getElementById("chat").classList.add("active");

    if(unsub) unsub();
    unsub = db.collection("private_chats").doc(activeChat).collection("messages")
        .onSnapshot(snap => {
            let data = [];
            snap.forEach(d => data.push({...d.data(), id: d.id}));
            
            // MANUAL SORT BY TIMESTAMP
            data.sort((a, b) => (a.ts || 0) - (b.ts || 0));

            const box = document.getElementById("messages");
            box.innerHTML = "";
            data.forEach(m => {
                const isMe = m.sender === myName;
                const ora = m.ts ? new Date(m.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "...";
                box.innerHTML += `
                    <div class="msg-row ${isMe?'me':'other'}">
                        <div class="bubble">${m.text}</div>
                        <div class="msg-info">${ora} ${isMe ? (m.seen?'âœ”âœ”':'âœ”') : ''}</div>
                    </div>`;
                if(!isMe && !m.seen) db.collection("private_chats").doc(activeChat).collection("messages").doc(m.id).update({seen:true});
            });
            box.scrollTop = box.scrollHeight;
        });

    // Listen Typing
    db.collection("private_chats").doc(activeChat).onSnapshot(d => {
        if(d.exists()) {
            document.getElementById("typingInfo").innerText = d.data()["typ_"+other] ? other + " manoratra..." : "";
        }
    });
}

function send() {
    const val = document.getElementById("msgInput").value.trim();
    if(!val) return;
    db.collection("private_chats").doc(activeChat).collection("messages").add({
        sender: myName,
        text: val,
        ts: Date.now(),
        seen: false
    });
    document.getElementById("msgInput").value = "";
    db.collection("private_chats").doc(activeChat).set({["typ_"+myName]: false}, {merge:true});
}

function isTyping() {
    db.collection("private_chats").doc(activeChat).set({
        ["typ_"+myName]: document.getElementById("msgInput").value.length > 0
    }, {merge:true});
}

// CALL FUNCTION
function makeCall() {
    const other = document.getElementById("chatTitle").innerText;
    document.getElementById("callName").innerText = other;
    document.getElementById("callImg").src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${other}`;
    document.getElementById("callScreen").style.display = "flex";
    db.collection("calls").doc(other).set({ caller: myName, status: "ringing" });
}

function listenCalls() {
    db.collection("calls").doc(myName).onSnapshot(d => {
        if(d.exists() && d.data().status === "ringing") {
            if(confirm("Miantso i " + d.data().caller + ". Handray?")) {
                alert("Mifandray ny feo...");
                db.collection("calls").doc(myName).delete();
            } else {
                db.collection("calls").doc(myName).delete();
            }
        }
    });
}

function endCall() {
    document.getElementById("callScreen").style.display = "none";
    const other = document.getElementById("chatTitle").innerText;
    db.collection("calls").doc(other).delete();
}

function closeChat() {
    document.getElementById("chat").classList.remove("active");
    document.getElementById("rooms").classList.add("active");
}

function logout() {
    db.collection("users").doc(myName).update({online: false});
    localStorage.clear();
    location.reload();
}

window.onload = () => { if(localStorage.chatUser) { document.getElementById("userName").value = localStorage.chatUser; login(); } }
</script>
</body>
</html>
