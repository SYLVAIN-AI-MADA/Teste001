<!DOCTYPE html>
<html lang="mg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>GlobalChat Premium | Sylvain</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg: #000;
    --card: #121212;
    --accent: #007aff;
    --text: #fff;
    --text-dim: #8e8e93;
    --border: rgba(255,255,255,0.1);
    --me: #007aff;
    --other: #262629;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body, html { margin:0; height:100%; font-family:'Plus Jakarta Sans',sans-serif; background:var(--bg); color:var(--text); overflow:hidden; }

.app-viewport { display:flex; width:200vw; height:100dvh; transition:0.4s ease; }
.app-viewport.in-chat { transform:translateX(-100vw); }
.sidebar, .main-chat { width:100vw; height:100%; display:flex; flex-direction:column; }

header { height:65px; padding:0 15px; display:flex; align-items:center; border-bottom:1px solid var(--border); background:rgba(0,0,0,0.8); backdrop-filter:blur(15px); z-index:10; }
.pdp-circle { width:40px; height:40px; border-radius:50%; background:var(--card); border:2px solid var(--accent); overflow:hidden; display:flex; align-items:center; justify-content:center; font-size:1.2rem; cursor:pointer; }
.pdp-circle img { width:100%; height:100%; object-fit:cover; }

.user-list { flex:1; overflow-y:auto; padding:15px; }
.user-card { display:flex; align-items:center; padding:12px; background:var(--card); border-radius:18px; margin-bottom:10px; cursor:pointer; border:1px solid transparent; }
.user-card:active { border-color:var(--accent); }

#msg-box { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px; }
.msg-row { display:flex; flex-direction:column; width:100%; }
.me-row { align-items:flex-end; }
.other-row { align-items:flex-start; }
.bubble { max-width:80%; padding:12px 16px; border-radius:20px; font-size:0.95rem; line-height:1.4; position:relative; word-break:break-word; }
.me { background:var(--me); color:white; border-bottom-right-radius:4px; }
.other { background:var(--other); color:white; border-bottom-left-radius:4px; }
.time { font-size:0.65rem; color:var(--text-dim); margin-top:4px; padding:0 5px; }

#typing-status { font-size:0.75rem; color:#31a24c; margin:5px 20px; height:15px; font-style:italic; }

.input-bar { padding:12px 15px; background:var(--bg); display:flex; align-items:center; gap:10px; border-top:1px solid var(--border); padding-bottom:calc(12px + env(safe-area-inset-bottom)); }
.input-bar input { flex:1; background:#1c1c1e; border:1px solid var(--border); border-radius:22px; padding:12px 18px; color:white; font-size:1rem; }
.send-btn { background:var(--accent); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:1.2rem; }

.modal { position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:100; display:flex; align-items:center; justify-content:center; padding:25px; }
.modal-content { background:#1c1c1e; width:100%; max-width:350px; padding:30px; border-radius:30px; text-align:center; border:1px solid var(--border); }
.emoji-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin:20px 0; }
.emoji-btn { font-size:1.8rem; cursor:pointer; transition:0.2s; }
.emoji-btn:hover { transform:scale(1.2); }
.hidden { display:none !important; }
.btn-full { width:100%; padding:15px; border-radius:15px; border:none; font-weight:bold; cursor:pointer; margin-top:10px; }
</style>
</head>
<body>

<div id="login-modal" class="modal">
    <div class="modal-content">
        <h2 style="margin-top:0">GlobalChat</h2>
        <div id="pdp-preview" class="pdp-circle" style="width:80px; height:80px; margin:0 auto 20px; font-size:2.5rem;">üë§</div>
        <input id="user-name" placeholder="Anaranao..." class="btn-full" style="background:#262629; color:white; text-align:center;">
        <div class="emoji-grid">
            <span class="emoji-btn" onclick="setPDP('üòé')">üòé</span>
            <span class="emoji-btn" onclick="setPDP('üî•')">üî•</span>
            <span class="emoji-btn" onclick="setPDP('‚ú®')">‚ú®</span>
            <span class="emoji-btn" onclick="setPDP('üëë')">üëë</span>
            <span class="emoji-btn" onclick="setPDP('üéÆ')">üéÆ</span>
        </div>
        <label style="display:block; color:var(--accent); cursor:pointer; margin-bottom:15px; font-weight:600;">
            üìÅ Safidy sary local
            <input type="file" class="hidden" accept="image/*" onchange="previewFile(this)">
        </label>
        <button onclick="startApp()" class="btn-full" style="background:var(--accent); color:white;">HIDITRA</button>
    </div>
</div>

<div class="app-viewport" id="viewport">
    <aside class="sidebar">
        <header>
            <div id="my-pdp-ui" class="pdp-circle">üë§</div>
            <h2 style="flex:1; margin-left:15px; font-size:1.3rem;">Actif izao</h2>
        </header>
        <div id="online-list" class="user-list">
            <p style="text-align:center; color:var(--text-dim); margin-top:20px;">Tsy misy olona en ligne...</p>
        </div>
        <footer style="text-align:center; padding:15px; font-size:0.7rem; color:var(--text-dim);">SYLVAIN &copy; 2026</footer>
    </aside>

    <main class="main-chat">
        <header>
            <div onclick="goBack()" style="font-size:1.5rem; color:var(--accent); margin-right:15px; cursor:pointer;">‚ùÆ</div>
            <div id="chat-pdp-ui" class="pdp-circle" style="width:35px; height:35px; border:none; margin-right:10px;"></div>
            <div style="flex:1">
                <b id="chat-title" style="font-size:1rem;">Anarana</b><br>
                <small id="chat-status" style="color:#31a24c; font-size:0.7rem;">Online</small>
            </div>
        </header>

        <div id="msg-box"></div>
        <div id="typing-status"></div>

        <div class="input-bar">
            <input id="msg-input" placeholder="Hafatra..." oninput="isTyping()" onkeydown="if(event.key==='Enter') send()">
            <button onclick="send()" class="send-btn">‚Üë</button>
        </div>
    </main>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAJAy-RPWZiqrngfpOVBxsq9FSvms5hFGI",
    authDomain: "lgbtq-pro.firebaseapp.com",
    projectId: "lgbtq-pro"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- GLOBAL ---
let me = "", myPdp = "üë§", target = "", unsubMsg = null, typeTimer;

// --- PDP ---
function setPDP(val){ myPdp = val; document.getElementById('pdp-preview').innerHTML = val; }
function previewFile(input){ 
    if(input.files && input.files[0]){
        const reader = new FileReader();
        reader.onload = e => { myPdp = `<img src="${e.target.result}">`; document.getElementById('pdp-preview').innerHTML = myPdp; };
        reader.readAsDataURL(input.files[0]);
    }
}

// --- SANITIZE ---
function escapeHTML(str){ return str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// --- START APP ---
function startApp(){
    const name = document.getElementById('user-name').value.trim();
    if(!name) return;
    me = name;
    document.getElementById('login-modal').classList.add('hidden');
    document.getElementById('my-pdp-ui').innerHTML = myPdp;
    
    db.collection("users").doc(me).set({name:me,pdp:myPdp,online:true,lastSeen:Date.now(),typing:""},{merge:true});
    listenOnlineUsers();
}

// --- ONLINE USERS ---
function listenOnlineUsers(){
    db.collection("users").where("online","==",true).onSnapshot(snap=>{
        const list=document.getElementById('online-list');
        list.innerHTML="";
        if(snap.size<=1) list.innerHTML = `<p style="text-align:center;color:var(--text-dim);margin-top:20px;">Ianao irery no ato...</p>`;
        snap.forEach(doc=>{
            if(doc.id===me) return;
            const u = doc.data();
            list.innerHTML += `<div class="user-card" onclick="openChat('${doc.id}','${u.pdp}')"><div class="pdp-circle" style="width:45px;height:45px;margin-right:15px;">${u.pdp}</div><b>${u.name}</b></div>`;
        });
    });
}

// --- OPEN CHAT ---
function openChat(name,pdp){
    target = name;
    document.getElementById('chat-title').innerText = name;
    document.getElementById('chat-pdp-ui').innerHTML = pdp;
    document.getElementById('viewport').classList.add('in-chat');
    const box = document.getElementById('msg-box');
    box.innerHTML = "";

    // LISTEN TYPING
    db.collection("users").doc(target).onSnapshot(doc=>{
        const u = doc.data();
        document.getElementById('typing-status').innerText = (u.typing===me)?(target+" manoratra..."):"";
        box.scrollTop = box.scrollHeight;
    });

    // LISTEN MESSAGES
    if(unsubMsg) unsubMsg();
    const connId = [me,target].sort().join("_");
    unsubMsg = db.collection("chats").doc(connId).collection("messages").orderBy("ts","asc")
    .onSnapshot(snap=>{
        box.innerHTML = "";
        snap.forEach(d=>{
            const m = d.data();
            const isMe = m.sender===me;
            const time = new Date(m.ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
            box.innerHTML += `<div class="msg-row ${isMe?'me-row':'other-row'}"><div class="bubble ${isMe?'me':'other'}">${escapeHTML(m.text)}</div><div class="time">${time}</div></div>`;
        });
        box.scrollTop = box.scrollHeight;
    });
}

// --- SEND MESSAGE ---
function send(){
    const inp = document.getElementById('msg-input');
    const val = inp.value.trim();
    if(!val) return;
    const connId = [me,target].sort().join("_");
    db.collection("chats").doc(connId).collection("messages").add({sender:me,text:val,ts:Date.now()});
    inp.value="";
    db.collection("users").doc(me).update({typing:""});
}

// --- TYPING STATUS ---
function isTyping(){
    if(!target) return;
    db.collection("users").doc(me).update({typing:target});
    clearTimeout(typeTimer);
    typeTimer = setTimeout(()=>{ db.collection("users").doc(me).update({typing:""}); },2000);
}

// --- GO BACK ---
function goBack(){ 
    document.getElementById('viewport').classList.remove('in-chat');
    db.collection("users").doc(me).update({typing:""});
}

// --- OFFLINE ---
window.addEventListener('beforeunload',()=>{
    if(me) db.collection("users").doc(me).update({online:false,typing:""});
});
</script>
</body>
</html>
