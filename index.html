<!DOCTYPE html>
<html lang="mg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>GlobalChat Pro | Multimedia</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
    --messenger-blue: #0084ff;
    --bg-main: #0b0b0b;
    --text-main: #ffffff;
    --bubble-me: #0084ff;
    --bubble-other: #242526;
    --glass: rgba(255, 255, 255, 0.08);
}

body.light-mode { --bg-main: #ffffff; --text-main: #050505; --bubble-other: #e4e6eb; --glass: rgba(0, 0, 0, 0.05); }
body.lgbt-mode { --bg-main: #12011a; --bubble-me: linear-gradient(45deg, #ff0000, #ff8c00, #ffeb00, #4eb120, #004dff, #750787); --bubble-other: #2d134d; }

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body, html { height: 100%; margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-main); color: var(--text-main); transition: 0.3s; }

.app { width: 100%; max-width: 500px; height: 100dvh; display: flex; flex-direction: column; margin: auto; position: relative; border-left: 1px solid var(--glass); border-right: 1px solid var(--glass); }

/* HEADER STYLE */
header { padding: 15px; display: flex; align-items: center; justify-content: space-between; background: var(--bg-main); border-bottom: 1px solid var(--glass); z-index: 100; }
.header-profile { display: flex; align-items: center; gap: 10px; }
.header-profile img { width: 35px; height: 35px; border-radius: 50%; }

/* MESSAGE AREA */
#messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; scroll-behavior: smooth; }

/* MESSENGER STYLE ALIGNMENT */
.msg-wrapper { display: flex; width: 100%; margin-bottom: 8px; flex-direction: column; }
.msg-wrapper.me { align-items: flex-end; }
.msg-wrapper.other { align-items: flex-start; }

.bubble { max-width: 75%; padding: 10px 14px; font-size: 0.95rem; line-height: 1.4; border-radius: 18px; position: relative; }
.me .bubble { background: var(--bubble-me); color: white; border-bottom-right-radius: 4px; }
.other .bubble { background: var(--bubble-other); color: var(--text-main); border-bottom-left-radius: 4px; }

/* MEDIA CONTENT */
.msg-media { max-width: 250px; border-radius: 12px; margin-top: 5px; cursor: pointer; border: 1px solid var(--glass); }
video.msg-media { background: #000; }

/* SEEN STATUS */
.seen-status { height: 16px; margin-top: 2px; }
.seen-avatar { width: 14px; height: 14px; border-radius: 50%; border: 1px solid var(--bg-main); }

/* INPUT BAR */
.input-bar { padding: 12px; display: flex; align-items: center; gap: 10px; background: var(--bg-main); border-top: 1px solid var(--glass); }
.input-bar input { flex: 1; padding: 10px 16px; border-radius: 20px; border: none; background: var(--bubble-other); color: var(--text-main); outline: none; }

.media-btns { display: flex; gap: 12px; color: var(--messenger-blue); font-size: 1.3rem; cursor: pointer; }

/* THEME PICKER */
.theme-dot { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 2px solid white; }

.hidden { display: none !important; }
</style>
</head>
<body>

<div class="app">
    <div id="loginPage" style="padding:40px; text-align:center; flex:1; display:flex; flex-direction:column; justify-content:center;">
        <h1 style="color:var(--messenger-blue); font-size: 2.5rem;">GlobalChat</h1>
        <p style="opacity: 0.6;">Dingan'ny multimedia sy interface vaovao</p>
        <input id="userName" placeholder="Anaranao..." style="width:100%; padding:15px; border-radius:12px; border:1px solid var(--glass); background:var(--bubble-other); color:var(--text-main); margin-bottom: 10px;">
        <button onclick="login()" style="width:100%; padding:15px; border-radius:12px; border:none; background:var(--messenger-blue); color:white; font-weight:bold; cursor:pointer;">HIDITRA</button>
    </div>

    <div id="mainUI" class="hidden" style="height:100dvh; display:flex; flex-direction:column;">
        <header id="listHeader">
            <b>GlobalChat</b>
            <div style="display:flex; gap:10px;">
                <div class="theme-dot" style="background:#000" onclick="setTheme('dark')"></div>
                <div class="theme-dot" style="background:#ddd" onclick="setTheme('light')"></div>
                <div class="theme-dot" style="background:linear-gradient(45deg, red, violet)" onclick="setTheme('lgbt')"></div>
            </div>
        </header>

        <div id="userList" style="flex:1; overflow-y:auto;"></div>

        <div id="chatBox" class="hidden" style="position:absolute; inset:0; background:var(--bg-main); display:flex; flex-direction:column; z-index:200;">
            <header>
                <div class="header-profile">
                    <button onclick="closeChat()" style="background:none; border:none; color:var(--messenger-blue); font-size:1.5rem; cursor:pointer;">‚úï</button>
                    <img id="chatAvatar" src="">
                    <b id="chatTitle">Name</b>
                </div>
                <div style="color:var(--messenger-blue); cursor:pointer;">üìû &nbsp; üé•</div>
            </header>
            
            <div id="messages"></div>

            <div class="input-bar">
                <div class="media-btns">
                    <span onclick="promptMedia('image')">üñºÔ∏è</span>
                    <span onclick="promptMedia('video')">üìπ</span>
                </div>
                <input id="msgInput" placeholder="Hafatra..." onkeydown="if(event.key==='Enter') send('text')">
                <div class="media-btns" onclick="send('text')">‚û§</div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAJAy-RPWZiqrngfpOVBxsq9FSvms5hFGI",
    authDomain: "lgbtq-pro.firebaseapp.com",
    projectId: "lgbtq-pro",
    storageBucket: "lgbtq-pro.firebasestorage.app",
    messagingSenderId: "188046971429",
    appId: "1:188046971429:web:b99215b46097c8ac8a65cc"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let myName = "";
let activeChat = "";
let unsub = null;

function setTheme(t) { document.body.className = t + "-mode"; }

function login() {
    const n = document.getElementById("userName").value.trim();
    if(!n) return;
    myName = n;
    localStorage.chatUser = n;
    db.collection("users").doc(n).set({ name: n, online: true }, {merge:true});
    document.getElementById("loginPage").classList.add("hidden");
    document.getElementById("mainUI").classList.remove("hidden");
    loadUsers();
}

function loadUsers() {
    db.collection("users").onSnapshot(snap => {
        const list = document.getElementById("userList");
        list.innerHTML = "";
        snap.forEach(doc => {
            if(doc.id !== myName) {
                list.innerHTML += `
                <div onclick="openChat('${doc.id}')" style="display:flex; align-items:center; padding:15px; gap:12px; cursor:pointer; border-bottom: 1px solid var(--glass);">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${doc.id}" style="width:55px; height:55px; border-radius:50%">
                    <div style="flex:1"><b>${doc.id}</b><br><small style="opacity:0.5">Tsindrio hiresahana...</small></div>
                </div>`;
            }
        });
    });
}

function openChat(other) {
    activeChat = [myName, other].sort().join("_");
    document.getElementById("chatTitle").innerText = other;
    document.getElementById("chatAvatar").src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${other}`;
    document.getElementById("chatBox").classList.remove("hidden");

    if(unsub) unsub();
    unsub = db.collection("private_chats").doc(activeChat).collection("messages")
        .orderBy("ts", "asc")
        .onSnapshot(snap => {
            const box = document.getElementById("messages");
            box.innerHTML = "";
            let data = [];
            snap.forEach(d => data.push({...d.data(), id: d.id}));

            const lastSeen = [...data].reverse().find(m => m.sender === myName && m.seen);

            data.forEach(m => {
                const isMe = m.sender === myName;
                let content = "";
                
                if(m.type === 'text') content = `<div class="bubble">${m.text}</div>`;
                else if(m.type === 'image') content = `<img src="${m.url}" class="msg-media">`;
                else if(m.type === 'video') content = `<video src="${m.url}" class="msg-media" controls></video>`;

                let html = `
                    <div class="msg-wrapper ${isMe?'me':'other'}">
                        ${content}
                        ${isMe && lastSeen && m.id === lastSeen.id ? `
                            <div class="seen-status">
                                <img class="seen-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=${other}">
                            </div>
                        ` : ''}
                    </div>`;
                box.innerHTML += html;

                if(!isMe && !m.seen) db.collection("private_chats").doc(activeChat).collection("messages").doc(m.id).update({seen:true});
            });
            box.scrollTop = box.scrollHeight;
        });
}

function send(type, url = "") {
    let msgData = { sender: myName, ts: Date.now(), seen: false, type: type };
    
    if(type === 'text') {
        const input = document.getElementById("msgInput");
        if(!input.value.trim()) return;
        msgData.text = input.value;
        input.value = "";
    } else {
        msgData.url = url;
    }

    db.collection("private_chats").doc(activeChat).collection("messages").add(msgData);
}

function promptMedia(type) {
    const url = prompt(`Alefaso ny URL-n'ny ${type} (ohatra: https://...):`);
    if(url) send(type, url);
}

function closeChat() { document.getElementById("chatBox").classList.add("hidden"); }

window.onload = () => { if(localStorage.chatUser) { document.getElementById("userName").value = localStorage.chatUser; login(); } }
</script>
</body>
</html>
